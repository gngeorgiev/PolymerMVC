<link rel="import" href="../polymer/polymer.html" />
<link rel="import" href="../core-meta/core-meta.html" />

<polymer-element name="polymer-view">

  <template>
    <template if="{{selected}}">
      <content></content>
    </template>
  </template>

  <script>
    Polymer('polymer-view', {
      publish: {
        selected: {
          value: false,
          refrect: true
        },
        controller: ''
      },
      ready: function() {
        var host = this.shadowRoot.host;
        if (host && host['registerView'] && typeof host['registerView'] === 'function') {
          host.registerView(this);
        }

        if (this.controller || typeof this.controller === 'string') {
          this.enqueueForAttach();
          this.forceControllerAttach();
        }

      },
      registerView: function(view) {
        if (!this.views) {
          this.views = [];
        }

        this.views.push(view);
      },
      enqueueForAttach: function() {
        var meta = document.createElement('core-meta');
        meta.type = 'ControllersQueue';
        var registeredMeta = meta.metaData[this.controller];
        if (!registeredMeta) {
          meta.views = [];
          meta.views.push(this);
          meta.register(this.controller);
        } else {
          registeredMeta.views.push(this);
        }
      },
      forceControllerAttach: function() {
        var meta = document.createElement('core-meta');
        meta.type = 'Controllers';
        var registeredMeta = meta.byId(this.controller);
        if (registeredMeta) {
          registeredMeta.controller.attachView();
        }
      },
      attachController: function(controller) {
        this._$controller = controller;
        this._$controller._$view = this;
        this._$scope = this.$controller.$scope;
        this.childNodes.array().forEach(function(node) {
          if (!node.tagName) {
            return;
          }

          node.$controller = controller;
          node.$scope = controller.$scope;
        });
      },
      get $controller() {
        return this._$controller;
      },
      get $scope() {
        return this._$scope;
      }
    });
  </script>

</polymer-element>
